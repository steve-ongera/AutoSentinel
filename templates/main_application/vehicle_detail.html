{% extends 'base.html' %}

{% block title %}{{ vehicle.year }} {{ vehicle.make }} {{ vehicle.model }} - AutoSentinel{% endblock %}

{% block extra_css %}
<style>
    .breadcrumb {

        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
      
    }
    
    .breadcrumb-item a {
        color: #4a90e2;
        text-decoration: none;
        font-weight: 500;
    }
    
    .breadcrumb-item.active {
        color: #6c757d;
    }
    
    .vehicle-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 2.5rem;
        border-radius: 12px;
        color: white;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }
    
    .vehicle-header::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 300px;
        height: 300px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        transform: translate(30%, -30%);
    }
    
    .vehicle-header-content {
        position: relative;
        z-index: 1;
    }
    
    .vehicle-title {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .vehicle-vin {
        font-family: 'Courier New', monospace;
        font-size: 1.125rem;
        opacity: 0.95;
        background: rgba(255, 255, 255, 0.2);
        padding: 0.5rem 1rem;
        border-radius: 6px;
        display: inline-block;
        margin-bottom: 1rem;
    }
    
    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.938rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .badge-stolen {
        background: rgba(220, 53, 69, 0.2);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.5);
        animation: pulse 2s infinite;
    }
    
    .badge-clean {
        background: rgba(40, 167, 69, 0.2);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.5);
    }
    
    .info-card {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #e1e8ed;
    }
    
    .info-card-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e1e8ed;
    }
    
    .info-card-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 0;
    }
    
    .info-card-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }
    
    .info-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .info-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }
    
    .info-label {
        font-size: 0.813rem;
        color: #6c757d;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .info-value {
        font-size: 1rem;
        color: #2c3e50;
        font-weight: 600;
    }
    
    .info-value code {
        background: #f8f9fa;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.938rem;
        color: #4a90e2;
    }
    
    .spec-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .accident-card {
        background: #fff5f5;
        border-left: 4px solid #dc3545;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .accident-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .accident-date {
        font-size: 1.125rem;
        font-weight: 700;
        color: #2c3e50;
    }
    
    .severity-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.813rem;
    }
    
    .severity-total {
        background: #dc3545;
        color: white;
    }
    
    .severity-severe {
        background: #ff9800;
        color: white;
    }
    
    .severity-minor {
        background: #6c757d;
        color: white;
    }
    
    .accident-details {
        color: #6c757d;
        font-size: 0.938rem;
        line-height: 1.6;
    }
    
    .accident-details strong {
        color: #2c3e50;
    }
    
    .timeline {
        position: relative;
        padding-left: 2rem;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        left: 8px;
        top: 8px;
        bottom: 8px;
        width: 2px;
        background: #e1e8ed;
    }
    
    .timeline-item {
        position: relative;
        padding-bottom: 1.5rem;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -1.5rem;
        top: 4px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: white;
        border: 3px solid #4a90e2;
        z-index: 1;
    }
    
    .timeline-item.rollback::before {
        border-color: #dc3545;
    }
    
    .timeline-date {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.25rem;
    }
    
    .timeline-mileage {
        font-size: 1.125rem;
        font-weight: 700;
        color: #4a90e2;
        margin-bottom: 0.25rem;
    }
    
    .timeline-source {
        font-size: 0.875rem;
        color: #6c757d;
    }
    
    .action-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #e1e8ed;
        position: sticky;
        top: 100px;
    }
    
    .action-btn {
        width: 100%;
        padding: 0.875rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.938rem;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        border: 2px solid;
    }
    
    .action-btn-primary {
        background: #4a90e2;
        border-color: #4a90e2;
        color: white;
    }
    
    .action-btn-primary:hover {
        background: #357abd;
        border-color: #357abd;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
    }
    
    .action-btn-outline {
        background: white;
        border-color: #e1e8ed;
        color: #2c3e50;
    }
    
    .action-btn-outline:hover {
        border-color: #4a90e2;
        color: #4a90e2;
    }
    
    .sidebar-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #e1e8ed;
    }
    
    .sidebar-card-header {
        font-size: 1rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #e1e8ed;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .plate-item {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        border: 1px solid #e1e8ed;
    }
    
    .plate-number {
        font-family: 'Courier New', monospace;
        font-size: 1.125rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 0.25rem;
    }
    
    .owner-item {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        border-left: 3px solid #4a90e2;
    }
    
    .owner-item.current {
        border-left-color: #28a745;
        background: rgba(40, 167, 69, 0.05);
    }
    
    .theft-alert {
        background: #fff5f5;
        border: 2px solid #dc3545;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        animation: pulse-border 2s infinite;
    }
    
    @keyframes pulse-border {
        0%, 100% { border-color: #dc3545; }
        50% { border-color: #ff6b6b; }
    }
    
    .theft-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
        color: #dc3545;
        font-size: 1.125rem;
        font-weight: 700;
    }
    
    .theft-icon {
        width: 48px;
        height: 48px;
        background: #dc3545;
        color: white;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }
    
    .table-modern {
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .table-modern thead th {
        background: #f8f9fa;
        font-weight: 600;
        color: #2c3e50;
        padding: 1rem;
        border: none;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .table-modern tbody td {
        padding: 1rem;
        border-bottom: 1px solid #e1e8ed;
        color: #2c3e50;
    }
    
    .table-modern tbody tr:last-child td {
        border-bottom: none;
    }
    
    .table-modern tbody tr:hover {
        background: #f8f9fa;
    }
    
    .table-modern tbody tr.rollback-row {
        background: #fff5f5;
    }
    
    .title-event-item {
        padding: 1rem;
        border-left: 3px solid #4a90e2;
        background: #f8f9fa;
        border-radius: 6px;
        margin-bottom: 0.75rem;
    }
    
    .title-event-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .title-event-date {
        font-weight: 700;
        color: #2c3e50;
    }
    
    .title-event-details {
        color: #6c757d;
        font-size: 0.875rem;
    }
    
    @media (max-width: 991px) {
        .action-card {
            position: static;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}"><i class="bi bi-house-door"></i> Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'vehicle_list' %}"><i class="bi bi-car-front"></i> Vehicles</a></li>
            <li class="breadcrumb-item active">{{ vehicle.vin }}</li>
        </ol>
    </nav>

    <!-- Vehicle Header -->
    <div class="vehicle-header">
        <div class="vehicle-header-content">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                <div>
                    <h1 class="vehicle-title">{{ vehicle.year }} {{ vehicle.make }} {{ vehicle.model }}</h1>
                    <div class="vehicle-vin">
                        <i class="bi bi-upc-scan"></i> VIN: {{ vehicle.vin }}
                    </div>
                    {% if vehicle.trim %}
                    <p class="mb-0" style="opacity: 0.9; font-size: 1.125rem;">{{ vehicle.trim }}</p>
                    {% endif %}
                </div>
                <div>
                    {% if vehicle.is_stolen %}
                    <div class="status-badge badge-stolen">
                        <i class="bi bi-exclamation-triangle-fill"></i> STOLEN VEHICLE
                    </div>
                    {% else %}
                    <div class="status-badge badge-clean">
                        <i class="bi bi-check-circle-fill"></i> CLEAN STATUS
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Basic Information -->
            <div class="info-card">
                <div class="info-card-header">
                    <h2 class="info-card-title">
                        <div class="info-card-icon" style="background: rgba(74, 144, 226, 0.1); color: #4a90e2;">
                            <i class="bi bi-info-circle"></i>
                        </div>
                        Vehicle Information
                    </h2>
                </div>
                
                <div class="info-row">
                    <div class="info-item">
                        <span class="info-label">VIN Number</span>
                        <span class="info-value"><code>{{ vehicle.vin }}</code></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Year</span>
                        <span class="info-value">{{ vehicle.year }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Make</span>
                        <span class="info-value">{{ vehicle.make }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Model</span>
                        <span class="info-value">{{ vehicle.model }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Trim Level</span>
                        <span class="info-value">{{ vehicle.trim|default:"Not Specified" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Body Style</span>
                        <span class="info-value">{{ vehicle.body_style|default:"Not Specified" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Color</span>
                        <span class="info-value">{{ vehicle.color|default:"Not Specified" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Current Mileage</span>
                        <span class="info-value">{{ vehicle.current_mileage|default:"Unknown" }} miles</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Title Status</span>
                        <span class="info-value">
                            <span class="spec-badge" style="background: {% if vehicle.current_title_status == 'clean' %}rgba(40, 167, 69, 0.1); color: #28a745{% else %}rgba(255, 152, 0, 0.1); color: #ff9800{% endif %};">
                                <i class="bi bi-{% if vehicle.current_title_status == 'clean' %}check-circle{% else %}exclamation-circle{% endif %}"></i>
                                {{ vehicle.get_current_title_status_display }}
                            </span>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Number of Owners</span>
                        <span class="info-value">{{ vehicle.current_owner_count }}</span>
                    </div>
                </div>
            </div>

            <!-- Technical Specifications -->
            {% if vehicle.engine or vehicle.transmission %}
            <div class="info-card">
                <div class="info-card-header">
                    <h2 class="info-card-title">
                        <div class="info-card-icon" style="background: rgba(40, 167, 69, 0.1); color: #28a745;">
                            <i class="bi bi-gear"></i>
                        </div>
                        Technical Specifications
                    </h2>
                </div>
                
                <div class="info-row">
                    <div class="info-item">
                        <span class="info-label">Engine</span>
                        <span class="info-value">{{ vehicle.engine|default:"Not Specified" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Transmission</span>
                        <span class="info-value">{{ vehicle.transmission|default:"Not Specified" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Drivetrain</span>
                        <span class="info-value">{{ vehicle.drivetrain|default:"Not Specified" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Fuel Type</span>
                        <span class="info-value">{{ vehicle.fuel_type|default:"Not Specified" }}</span>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Accident History -->
            {% if has_accidents %}
            <div class="info-card">
                <div class="info-card-header">
                    <h2 class="info-card-title">
                        <div class="info-card-icon" style="background: rgba(220, 53, 69, 0.1); color: #dc3545;">
                            <i class="bi bi-exclamation-triangle"></i>
                        </div>
                        Accident History
                    </h2>
                </div>
                
                {% for accident in accidents %}
                <div class="accident-card">
                    <div class="accident-header">
                        <span class="accident-date">
                            <i class="bi bi-calendar-event"></i> {{ accident.accident_date }}
                        </span>
                        <span class="severity-badge severity-{{ accident.severity }}">
                            {{ accident.get_severity_display }}
                        </span>
                    </div>
                    <div class="accident-details">
                        <p class="mb-2"><strong>Source:</strong> {{ accident.get_source_display }}</p>
                        {% if accident.damage_description %}
                        <p class="mb-2"><strong>Damage Description:</strong> {{ accident.damage_description }}</p>
                        {% endif %}
                        {% if accident.estimated_damage_cost %}
                        <p class="mb-0"><strong>Estimated Cost:</strong> <span style="color: #dc3545; font-weight: 700;">${{ accident.estimated_damage_cost|floatformat:2 }}</span></p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Mileage History -->
            {% if mileage_records %}
            <div class="info-card">
                <div class="info-card-header">
                    <h2 class="info-card-title">
                        <div class="info-card-icon" style="background: rgba(23, 162, 184, 0.1); color: #17a2b8;">
                            <i class="bi bi-speedometer2"></i>
                        </div>
                        Mileage History
                    </h2>
                </div>
                
                <div class="timeline">
                    {% for record in mileage_records %}
                    <div class="timeline-item {% if record.is_rollback_suspected %}rollback{% endif %}">
                        <div class="timeline-date">{{ record.recorded_date }}</div>
                        <div class="timeline-mileage">
                            {{ record.mileage|default:"Unknown" }} {{ record.unit }}
                            {% if record.is_rollback_suspected %}
                                    <span class="spec-badge" style="background: rgba(220, 53, 69, 0.1); color: #dc3545;">
                                <i class="bi bi-exclamation-triangle-fill"></i> Rollback Suspected
                            </span>
                            {% endif %}
                        </div>
                        <div class="timeline-source">
                            <i class="bi bi-building"></i> {{ record.get_source_display }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Title Events -->
            {% if title_events %}
            <div class="info-card">
                <div class="info-card-header">
                    <h2 class="info-card-title">
                        <div class="info-card-icon" style="background: rgba(108, 117, 125, 0.1); color: #6c757d;">
                            <i class="bi bi-file-earmark-text"></i>
                        </div>
                        Title Event History
                    </h2>
                </div>
                
                {% for event in title_events %}
                <div class="title-event-item">
                    <div class="title-event-header">
                        <span class="title-event-date">
                            <i class="bi bi-calendar3"></i> {{ event.event_date }}
                        </span>
                        <span class="spec-badge" style="background: rgba(74, 144, 226, 0.1); color: #4a90e2;">
                            {{ event.get_event_type_display }}
                        </span>
                    </div>
                    <div class="title-event-details">
                        <i class="bi bi-geo-alt"></i> {{ event.state }} • 
                        <strong>{{ event.get_title_status_display }}</strong>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Actions -->
            <div class="action-card">
                <h3 class="sidebar-card-header">
                    <i class="bi bi-lightning"></i> Quick Actions
                </h3>
                <a href="{% url 'generate_report' vehicle.vin %}" class="action-btn action-btn-primary">
                    <i class="bi bi-file-earmark-text"></i> Generate Full Report
                </a>
                <a href="{% url 'vehicle_history' vehicle.vin %}" class="action-btn action-btn-outline">
                    <i class="bi bi-clock-history"></i> View Complete History
                </a>
                {% if vehicle.consenting_for_tracking %}
                <a href="{% url 'vehicle_tracking' vehicle.vin %}" class="action-btn action-btn-outline">
                    <i class="bi bi-geo-alt"></i> GPS Tracking
                </a>
                {% endif %}
                {% if user.is_authenticated %}
                <a href="{% url 'submit_report' vehicle.vin %}" class="action-btn action-btn-outline">
                    <i class="bi bi-flag"></i> Report an Issue
                </a>
                {% endif %}
            </div>

            <!-- Theft Alert -->
            {% if has_theft %}
            <div class="theft-alert">
                <div class="theft-header">
                    <div class="theft-icon">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                    </div>
                    <span>THEFT ALERT</span>
                </div>
                {% for theft in theft_records %}
                <div class="mb-3">
                    <p class="mb-2"><strong>Status:</strong> <span class="spec-badge" style="background: #dc3545; color: white;">{{ theft.get_status_display }}</span></p>
                    <p class="mb-2"><strong>Reported Date:</strong> {{ theft.reported_date }}</p>
                    <p class="mb-2"><strong>Reporting Agency:</strong> {{ theft.reporting_agency }}</p>
                    {% if theft.ncic_number %}
                    <p class="mb-0"><strong>NCIC Number:</strong> <code>{{ theft.ncic_number }}</code></p>
                    {% endif %}
                </div>
                {% endfor %}
                <div class="alert alert-danger mb-0 mt-3" style="border: none; font-size: 0.875rem;">
                    <i class="bi bi-info-circle"></i> If you have information about this vehicle, contact local authorities immediately.
                </div>
            </div>
            {% endif %}

            <!-- License Plates -->
            {% if registrations %}
            <div class="sidebar-card">
                <h3 class="sidebar-card-header">
                    <i class="bi bi-credit-card-2-front"></i> License Plates
                </h3>
                {% for reg in registrations %}
                <div class="plate-item">
                    <div class="plate-number">{{ reg.plate_number }}</div>
                    <div class="d-flex gap-2 align-items-center flex-wrap">
                        <span class="spec-badge" style="background: rgba(74, 144, 226, 0.1); color: #4a90e2;">
                            <i class="bi bi-geo-alt"></i> {{ reg.state }}
                        </span>
                        {% if reg.is_current %}
                        <span class="spec-badge" style="background: rgba(40, 167, 69, 0.1); color: #28a745;">
                            <i class="bi bi-check-circle"></i> Current
                        </span>
                        {% endif %}
                    </div>
                    <p class="mb-0 mt-2" style="font-size: 0.875rem; color: #6c757d;">
                        <i class="bi bi-calendar"></i> Issued: {{ reg.issued_date }}
                    </p>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Ownership History -->
            {% if ownership_records %}
            <div class="sidebar-card">
                <h3 class="sidebar-card-header">
                    <i class="bi bi-people"></i> Ownership History
                </h3>
                {% for owner in ownership_records %}
                <div class="owner-item {% if owner.is_current %}current{% endif %}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span style="font-weight: 700; color: #2c3e50;">
                            <i class="bi bi-person"></i> Owner #{{ owner.owner_sequence }}
                        </span>
                        {% if owner.is_current %}
                        <span class="spec-badge" style="background: rgba(40, 167, 69, 0.1); color: #28a745;">
                            <i class="bi bi-check-circle"></i> Current Owner
                        
                        </span>
                        {% endif %}
                    </div>
                    <p class="mb-1" style="font-size: 0.875rem; color: #6c757d;">
                        <i class="bi bi-calendar"></i> Owned from {{ owner.start_date }} to {% if owner.end_date %}{{ owner.end_date }}{% else %}Present{% endif %}
                    </p>
                    <p class="mb-0" style="font-size: 0.875rem; color: #6c757d;">
                        <i class="bi bi-geo-alt"></i> Location: {{ owner.city }}, {{ owner.state }}
                    </p>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}